
<div id="digest">

  <style>h3 a.btn { float: right }</style>

  <% if @message %>
    <%= @message %>
  <% end %>

  <h2>       
    <% if @email %>
      <%=@heading%> <small><%=compact_daterange(@from,@to)%></small>      
    <% else %>
      Digest for <%= @group ? "#{@group.slug}" : 'your groups' %>
      <small>
        <script>
          $(function() {
            $("#digest .datepicker").datepicker({format: 'dd-M-yyyy', autoclose: true});
            $('#from-to').submit(function(e) {
              e.preventDefault();
              $('#digest').load('<%= @group ? "/groups/#{@group.slug}/digest" : "/digest" %>?' + $(this).serialize(), function() {
                $(this).children(':first').unwrap();
              });
              return false;
            });
          });
        </script>
        <form style="display: inline" id="from-to">
          <input type="text" onchange="$(this).closest('form').submit()" style="width: 8em; display: inline-block" class="form-control datepicker" name="from" value="<%=@from.strftime('%d-%b-%Y')%>"/>
          &ndash;
          <input type="text" onchange="$(this).closest('form').submit()" style="width: 8em; display: inline-block" class="form-control datepicker" name="to" value="<%=@to.strftime('%d-%b-%Y')%>"/>
        </form>
      </small>
    <% end %>    
  </h2> 

  <% content_for :hot_conversations do %>
    <% if @hot_conversations.length > 0 %>
      <h3>Hot conversations <% if @group %><a class="btn btn-default btn-sm" href="/groups/<%=@group.slug%>"><i class="fa fa-comments"></i> Browse all conversations</a><% end%></h3>
      <%= partial :'conversations/conversations_table', :locals => {:conversations => @hot_conversations} %>
    <% end %>   
  <% end %>

  <% content_for :upcoming_events do %>
    <% if @upcoming_events.length > 0 %> 
      <h3>Upcoming events</h3>
      <ul class="list-unstyled">
        <% @upcoming_events.each { |event| %>
          <li><a href="/groups/<%=event.group.slug%>/calendar/<%=event.id%>"><%=event.name%></a> <%= event.when_details %> <% if !@group%><span style="color: #999999;"><i class="fa fa-group"></i> <%=event.group.slug%></span><% end%></li>
        <% } %>
      </ul>
    <% end %>  
  <% end %>

  <% content_for :new_events do %>
    <% if @new_events.length > 0 %>
      <h3>New events <a class="btn btn-default btn-sm" href="<%= @group ? "/groups/#{@group.slug}/calendar/add" : "/calendar/add"%>"><i class="fa fa-plus"></i> Add an event</a></h3>
      <ul class="list-unstyled">
        <% @new_events.each { |event| %>
          <li><a href="/groups/<%=event.group.slug%>/calendar/<%=event.id%>"><%=event.name%></a> <%= event.when_details %> <% if !@group%><span style="color: #999999;"><i class="fa fa-group"></i> <%=event.group.slug%></span><% end%></li>
        <% } %>
      </ul>
    <% end %>    
  <% end %>

  <% content_for :new_people do %>
    <% if @new_people.length > 0 %>
      <h3>New people <a class="btn btn-default btn-sm" href="<%= @group ? "/groups/#{@group.slug}" : "/"%>"><i class="fa fa-group"></i> View all people</a></h3>
      <ul class="list-unstyled clearfix" style="margin-top: 26px">    
        <% @new_people.each { |account| %>
          <li style="display: block; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; padding: 5px">      
            <%= partial :'accounts/account', :locals => {:account => account} %>
          </li>
        <% } %>    
      </ul>
    <% end %>  
  <% end %>

  <% content_for :top_stories do %>
    <% if @top_stories.any? { |news_summary,stories| stories.length > 0 } %>  
      <h3>Top stories</h3>
      <% @top_stories.each { |news_summary,stories|  %>
        <h4 style="font-size: 21px; line-height: 110%; color: #999"><%=news_summary.title%><% if !@group %> <small><i class="fa fa-group"></i> <%=news_summary.group.slug%></small><% end %></h4>
        <div class="news-summary" style="margin-bottom: 20px">
          <ol class="top-stories stories-list">
            <% stories.each_with_index { |e,i| %>
              <li class="stories-list-item" id="story-<%=i%>">
                <%               
                h5 = e[:story].at_css('h5')
                h5.inner_html += " <small>#{(d = e[:daily_digest].date).strftime("%a #{d.day.ordinalize} %b")}</small>"
              %>
                <%= e[:story] %>
              </li>
            <% } %>
          </ol>
        </div>
      <% } %>
    <% end %>   
  <% end %>

  <% if @review %>
    <%= yield_content :upcoming_events %>
    <%= yield_content :new_events %>
    <%= yield_content :hot_conversations %>        
    <%= yield_content :new_people %>        
    <%= yield_content :top_stories %>        
  <% else %>        
    <%= yield_content :hot_conversations %>        
    <%= yield_content :upcoming_events %>
    <%= yield_content :new_events %>        
    <%= yield_content :new_people %>        
    <%= yield_content :top_stories %>    
  <% end %>

</div>