<h2> 
  <% if @wall_post %>
    Wall post by <%=@wall_post.account.name%>
  <% else %>     
    Wall for <%= @group ? "#{@group.slug}" : 'your groups' %> 
  <% end %>
</h2> 

<div style="background: #F5F5F5; padding: 10px;">

  <% if @wall_posts %>
    <div class="media">
      <span class="pull-left" >      
        <img class="media-object" style="width: 48px" src="<%=current_account.picture ? current_account.picture.thumb('48x48#').url : '/images/silhouette.png' %>">
      </span>
      <div class="media-body">    
        <% form_tag "/groups/#{@group.slug}/wall/new", :id => 'wall-form', :class => 'form-horizontal', :multipart => true do %>
          <%= text_area_tag :'wall_post[body]', :class => 'form-control', :id => 'wall_post_body', :style => 'display: block; margin-bottom: 10px', :rows => 5 %>              
          <div id="opengraph" style="position: relative; margin-bottom: 10px"></div>
          <div id="opengraph-json"></div>
          <button type="submit" class="btn btn-default">Post</button>
        <% end %> 
      </div>
    </div> 
  <% end %>

  <% (@wall_post ? [@wall_post] : @wall_posts).each { |wall_post| %>
    <%= partial :'wall/wall_post', :object => wall_post %>
  <% } %>

</div>

<script>
  $(function() {
    $('#wall_post_body').typing({
      stop: function(event, $elem) {
        var urlPattern = /(http|ftp|https):\/\/[\w-]+(\.[\w-]+)+([\w.,@?^=%&amp;:\/~+#-]*[\w@?^=%&amp;\/~+#-])?/
        var m = $($elem).val().match(urlPattern);
        if (m) {
          $('#opengraph').html('<i style="position: absolute; top: 0; right: 5px;" class="fa fa-spinner fa-spin"></i>')
          $('#opengraph').load('/wall/opengraph?url=' + encodeURIComponent(m[0]), function() {
            var r = $('<a style="position: absolute; top: 0; right: 5px;" class="edit" title="Remove link" href="javascript:;"><i class="fa fa-times"></i></a>');
            r.click(function() {
              $('#opengraph').html('')
              $('#opengraph-json').html('')
            });
            r.prependTo('#opengraph');
          });
          $('#opengraph-json').html('')
          $.getJSON('/wall/opengraph.json?url=' + encodeURIComponent(m[0]), function(data) {
            $.each(['title', 'url', 'description', 'player', 'picture'], function(i, x) {
              if (data[x])
                $('#opengraph-json').append('<input type="hidden" name="wall_post[' + x + ']" value="' + data[x] + '">')
            });
          })
        }
      },
      delay: 400
    });
  });
</script>


